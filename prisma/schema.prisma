// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Users table - stores user accounts (wallet-based or email-based)
model User {
  id            String   @id @default(cuid())
  username      String?  @unique  // Made optional for wallet-first onboarding
  email         String?  @unique
  password      String?  // For email/password auth
  walletAddress String?  @unique @map("wallet_address")
  avatar        String?  @default("https://api.dicebear.com/7.x/avataaars/svg")
  coverImage    String?  @map("cover_image")  // Cover/banner image for profile
  bio           String?
  isAI          Boolean  @default(false) @map("is_ai") // AI streamers that are always live
  hasCompletedOnboarding Boolean @default(false) @map("has_completed_onboarding")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Profile fields
  displayName          String?  @map("display_name")  // Display name (can be different from username)
  greeting             String?  @default("welcome to my channel")
  subscriptionPrice    Float?   @default(4.99) @map("subscription_price")
  subscriptionsEnabled Boolean  @default(true) @map("subscriptions_enabled")
  isVerified           Boolean  @default(false) @map("is_verified")

  // Relations
  streams       Stream[]
  sentTips      Tip[]      @relation("SentTips")
  receivedTips  Tip[]      @relation("ReceivedTips")
  followers     Follower[] @relation("Following")
  following     Follower[] @relation("Followers")
  posts         Post[]

  @@map("users")
}

// Posts table - stores user content (videos, images, replays)
model Post {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  type         String   @default("free") // free, paid, locked, replay
  title        String?
  description  String?
  thumbnailUrl String?  @map("thumbnail_url")
  contentUrl   String?  @map("content_url")
  price        Float?   // Price in SOL for paid content
  viewerCount  Int      @default(0) @map("viewer_count")
  isPublished  Boolean  @default(true) @map("is_published")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("posts")
}

// Streams table - tracks live stream sessions
model Stream {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  streamKey  String    @unique @map("stream_key")
  title      String?
  thumbnail  String?   @db.Text // Base64 thumbnail image
  isLive     Boolean   @default(false) @map("is_live")
  startedAt  DateTime? @map("started_at")
  endedAt    DateTime? @map("ended_at")
  viewerCount Int      @default(0) @map("viewer_count")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  tips Tip[]

  @@map("streams")
}

// Tips table - records all tip transactions on Solana
model Tip {
  id          String   @id @default(cuid())
  streamId    String?  @map("stream_id")
  fromWallet  String   @map("from_wallet")
  toWallet    String   @map("to_wallet")
  amountSol   Float    @map("amount_sol")
  txSignature String   @unique @map("tx_signature")
  message     String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  stream       Stream? @relation(fields: [streamId], references: [id], onDelete: SetNull)
  sender       User    @relation("SentTips", fields: [fromWallet], references: [walletAddress])
  recipient    User    @relation("ReceivedTips", fields: [toWallet], references: [walletAddress])

  @@map("tips")
}

// Followers table - tracks user follows
model Follower {
  id          String   @id @default(cuid())
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  follower  User @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@map("followers")
}
